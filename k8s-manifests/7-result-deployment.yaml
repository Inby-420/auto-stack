apiVersion: apps/v1
kind: Deployment
metadata:
  name: result-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: result
  template:
    metadata:
      labels:
        app: result
        
      # --- THIS IS THE VAULT INTEGRATION ---
      annotations:
        vault.hashicorp.com/agent-inject: 'true'
        vault.hashicorp.com/role: 'default' # Use the default K8s role
        
        # 1. Define the secret we want to get
        vault.hashicorp.com/agent-inject-secret-db-creds: 'secret/data/database'
        
        # 2. Template for injecting the secret's data as env vars
        vault.hashicorp.com/agent-inject-template-db-creds: |
          {{- with secret "secret/data/database" -}}
          export DB_HOST={{ .Data.data.db_host | squote }}
          export DB_NAME={{ .Data.data.db_name | squote }}
          export DB_USER={{ .Data.data.db_user | squote }}
          export DB_PASS={{ .Data.data.db_pass | squote }}
          {{- end }}
      # --- END OF VAULT INTEGRATION ---

    spec:
      # This service account is automatically configured by the Vault Helm chart
      serviceAccountName: default

      # This container waits for the worker service to be ready
      initContainers:
      - name: check-worker-ready
        image: busybox:1.36
        imagePullPolicy: IfNotPresent
        command: ['sh', '-c',
          'until nc -zv worker-svc 8525; do echo "Waiting for worker..."; sleep 2; done;']

      containers:
        - name: result
          # This image name MUST match your GitHub Container Registry
          image: ghcr.io/inby-420/auto-stack/result-node:0.2
          # This forces K8s to pull the new image every time
          imagePullPolicy: Always
          ports:
            - containerPort: 8080

          # The environment variables are now injected by the Vault Injector

          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 20
      
      # This is the secret for pulling the private image from GHCR
      imagePullSecrets:
        - name: ghcr-secret
