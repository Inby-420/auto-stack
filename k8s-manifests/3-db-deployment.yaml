apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
      
      # --- THIS IS THE NEW VAULT INTEGRATION ---
      annotations:
        vault.hashicorp.com/agent-inject: 'true'
        vault.hashicorp.com/role: 'default'
        
        # 1. Define the secret we want
        vault.hashicorp.com/agent-inject-secret-db-creds: 'secret/data/database'
        
        # 2. Template to inject ONLY the POSTGRES_ variables
        #    that this pod needs to initialize.
        vault.hashicorp.com/agent-inject-template-db-creds: |
          {{- with secret "secret/data/database" -}}
          export POSTGRES_DB={{ .Data.data.POSTGRES_DB | squote }}
          export POSTGRES_USER={{ .Data.data.POSTGRES_USER | squote }}
          export POSTGRES_PASSWORD={{ .Data.data.POSTGRES_PASSWORD | squote }}
          {{- end }}
      # --- END OF VAULT INTEGRATION ---

    spec:
      # Use the 'default' service account which we gave Vault access to
      serviceAccountName: default
      
      containers:
        - name: postgres
          image: postgres:15-alpine
          ports:
            - containerPort: 5432
          
          # --- DELETED ---
          # We no longer use the insecure 'envFrom: secretRef'
          
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
      volumes:
        - name: postgres-storage
          persistentVolumeClaim:
            claimName: postgres-pvc
