apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
      
      # --- THIS IS THE VAULT INTEGRATION ---
      annotations:
        vault.hashicorp.com/agent-inject: 'true'
        vault.hashicorp.com/role: 'default'
        
        # 1. Define the secret we want
        vault.hashicorp.com/agent-inject-secret-db-creds: 'secret/data/database'
        
        # 2. Template to inject ONLY the POSTGRES_ variables
        #    that this pod needs to initialize.
        vault.hashicorp.com/agent-inject-template-db-creds: |
          {{- with secret "secret/data/database" -}}
          export POSTGRES_DB={{ .Data.data.POSTGRES_DB | printf "%q" }}
          export POSTGRES_USER={{ .Data.data.POSTGRES_USER | printf "%q" }}
          export POSTGRES_PASSWORD={{ .Data.data.POSTGRES_PASSWORD | printf "%q" }}
          {{- end }}
        
        # This tells the agent to create the file at this path
        vault.hashicorp.com/agent-inject-secret-destination: 'db-creds'
      # --- END OF VAULT INTEGRATION ---

    spec:
      # Use the 'default' service account which we gave Vault access to
      serviceAccountName: default
      
      containers:
        - name: postgres
          image: postgres:15-alpine
        
          # We wrap the original command to source the new secret file first.
          command: ["/bin/sh", "-c"]
          args:
            - . /vault/secrets/db-creds && docker-entrypoint.sh postgres
          
          ports:
            - containerPort: 5432
          
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
      volumes:
        - name: postgres-storage
          persistentVolumeClaim:
            claimName: postgres-pvc
